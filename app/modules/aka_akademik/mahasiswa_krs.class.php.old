<?php
if (!defined('BASEPATH'))
	exit('No direct script access allowed');

class mahasiswa_krs extends AEFW {

	function __construct() {
		parent::__construct();
		if ($this -> session -> is_login() == FALSE)
			redirect('users/user/login');
	}

	function index() {
		if(!permissions('aka_mhs_krs', 'read')&&!permissions('aka_dpa', 'read')) show_error('Access Denied', 'You are not have permission !', 403);
		$this -> load -> libraries('input');
		$this -> load -> helpers('aka_master');

		$this -> asset -> load(array('jquery.datatable','jquery.chosen','fancybox'));
		$data['msg'] = '';
		$data['tahun_ajaran'] = aka_tahun_ajaran();
		$data['semester'] = aka_semester();
		$data['enc'] = $this -> input -> get('enc');
		$id_mhs_mahasiswa = (isset($this -> session -> data('detail') -> id_mhs_mahasiswa)) ? $this -> session -> data('detail') -> id_mhs_mahasiswa : '';

		$Sql = "SELECT *
		from {prefix}aka_dpa_mahasiswa
		join {prefix}aka_dpa using(id_aka_dpa)
		join {prefix}peg_pegawai using(id_peg_pegawai)
		where 1=1
		and (id_mhs_mahasiswa='".escape_string($id_mhs_mahasiswa)."' or md5(concat('".date('Ymd')."',id_mhs_mahasiswa))='".escape_string($data['enc'])."')
		";
		$Query = $this -> db -> query($Sql);
		$data['DPAs'] = $Query->result_object();

		$Sql = "SELECT *
		from {prefix}mhs_mahasiswa
		join {prefix}mst_prodi using(id_mst_prodi)
		left outer join {prefix}mst_kelas using(id_mst_kelas)
		where 1=1
		and (id_mhs_mahasiswa='".escape_string($id_mhs_mahasiswa)."' or md5(concat('".date('Ymd')."',id_mhs_mahasiswa))='".escape_string($data['enc'])."')
		";
		$Query = $this -> db -> query($Sql);
		$data['Data'] = $Query->fetch_object();
		if( ! isset($data['Data']->id_mhs_mahasiswa) ) $data['Data'] = false;

		$data['is_krs'] = is_jadwal_krs($data['tahun_ajaran'], $data['semester']);

		$data['isAkaBlocked'] =
		$isAkaBlocked = isAkaBlocked($data['Data']->id_mhs_mahasiswa);
		if( $data['enc']==false && $isAkaBlocked ) $data['msg'] = ui_error($isAkaBlocked->description);

		$data['isKrsBlocked'] =
		$isKrsBlocked = isKrsBlocked($data['Data']->id_mhs_mahasiswa, $data['tahun_ajaran'], $data['semester'], $data['Data']->id_mst_prodi);
		if( $data['enc']==false && $isKrsBlocked ) $data['msg'] = ui_error($isKrsBlocked->description);

		$data['breadcrumbs'] = array(base_url()=>'Dashboard', site_url('aka_akademik/mahasiswa_krs')=>'Akademik', 'KRS');
		$data['content'] = $this -> load -> view('mahasiswa_krs/index', $data, TRUE);
		$this -> template_admin -> view($data);
	}

	function sks_total() {
		if(!permissions('aka_mhs_krs', 'read')&&!permissions('aka_dpa', 'read')) show_error('Access Denied', 'You are not have permission !', 403);
		$this -> load -> libraries('input');
		$this -> load -> helpers('aka_master');

		$data['msg'] = '';
		$data['tahun_ajaran'] = aka_tahun_ajaran();
		$data['semester'] = aka_semester();
		$data['enc'] = $this -> input -> get('enc');
		$id_mhs_mahasiswa = (isset($this -> session -> data('detail') -> id_mhs_mahasiswa)) ? $this -> session -> data('detail') -> id_mhs_mahasiswa : '';

		$Sql = "SELECT *
		from {prefix}mhs_mahasiswa
		where 1=1
		and (id_mhs_mahasiswa='".escape_string($id_mhs_mahasiswa)."' or md5(concat('".date('Ymd')."',id_mhs_mahasiswa))='".escape_string($data['enc'])."')
		";
		$Query = $this -> db -> query($Sql);
		$Data = $Query->fetch_object();
		$total = aka_sks_total($Data->id_mhs_mahasiswa, $data['tahun_ajaran'], $data['semester']);
		if( $total <= 0 ) $total = 0;
		echo $total.' sks';
	}

	function sks_maximum() {
		if(!permissions('aka_mhs_krs', 'read')&&!permissions('aka_dpa', 'read')) show_error('Access Denied', 'You are not have permission !', 403);
		$this -> load -> libraries('input');
		$this -> load -> helpers('aka_master');

		$data['msg'] = '';
		$data['tahun_ajaran'] = aka_tahun_ajaran();
		$data['semester'] = aka_semester();
		$data['enc'] = $this -> input -> get('enc');
		$id_mhs_mahasiswa = (isset($this -> session -> data('detail') -> id_mhs_mahasiswa)) ? $this -> session -> data('detail') -> id_mhs_mahasiswa : '';

		$Sql = "SELECT *
		from {prefix}mhs_mahasiswa
		where 1=1
		and (id_mhs_mahasiswa='".escape_string($id_mhs_mahasiswa)."' or md5(concat('".date('Ymd')."',id_mhs_mahasiswa))='".escape_string($data['enc'])."')
		";
		$Query = $this -> db -> query($Sql);
		$Data = $Query->fetch_object();
		$total = getMaximumKrs($Data->id_mhs_mahasiswa, $data['tahun_ajaran'], $data['semester'], $Data->id_mst_prodi);
		if( $total <= 0 ) $total = 0;
		echo $total.' sks';
	}

	function status_view() {
		if(!permissions('aka_mhs_krs', 'read')&&!permissions('aka_dpa', 'read')) show_error('Access Denied', 'You are not have permission !', 403);
		$this -> load -> libraries('input');
		$this -> load -> helpers('aka_master');

		$this -> asset -> load(array('jquery.datatable','jquery.chosen','fancybox'));
		$data['msg'] = '';
		$data['tahun_ajaran'] = aka_tahun_ajaran();
		$data['semester'] = aka_semester();
		$data['enc'] = $this -> input -> get('enc');
		$id_mhs_mahasiswa = (isset($this -> session -> data('detail') -> id_mhs_mahasiswa)) ? $this -> session -> data('detail') -> id_mhs_mahasiswa : '';

		$Sql = "SELECT id_mhs_mahasiswa,nim,mahasiswa_nama from {prefix}mhs_mahasiswa
		where 1=1
		and (id_mhs_mahasiswa='".escape_string($id_mhs_mahasiswa)."' or md5(concat('".date('Ymd')."',id_mhs_mahasiswa))='".escape_string($data['enc'])."')
		";
		$Query = $this -> db -> query($Sql);
		$data['Data'] = $Query->fetch_object();

		$data['breadcrumbs'] = array(base_url()=>'Dashboard', site_url('aka_akademik/mahasiswa_krs')=>'Akademik', 'KRS');
		$data['content'] = $this -> load -> view('mahasiswa_krs/status_view', $data, TRUE);
		if( is_ajax() ) exit($data['content']);
		$this -> template_admin -> view($data);
	}

	function status_form() {
		if( isset($this -> session -> data('detail') -> id_mhs_mahasiswa) ) exit('');
		if(!permissions('aka_dpa_krs', 'create')&&!permissions('aka_dpa_krs', 'update')) exit('-');//show_error('Access Denied', 'You are not have permission !', 403);
		$this -> load -> libraries('input');
		$this -> load -> helpers('aka_master');

		$this -> asset -> load(array('jquery.datatable','jquery.chosen','fancybox'));
		$data['msg'] = '';
		$data['tahun_ajaran'] = aka_tahun_ajaran();
		$data['semester'] = aka_semester();
		$data['enc'] = $this -> input -> get('enc');
		$id_mhs_mahasiswa = (isset($this -> session -> data('detail') -> id_mhs_mahasiswa)) ? $this -> session -> data('detail') -> id_mhs_mahasiswa : '';

		$Sql = "SELECT id_mhs_mahasiswa,nim,mahasiswa_nama from {prefix}mhs_mahasiswa
		where 1=1
		and (id_mhs_mahasiswa='".escape_string($id_mhs_mahasiswa)."' or md5(concat('".date('Ymd')."',id_mhs_mahasiswa))='".escape_string($data['enc'])."')
		";
		$Query = $this -> db -> query($Sql);
		$data['Data'] = $Query->fetch_object();

		$data['is_krs'] = is_jadwal_krs($data['tahun_ajaran'], $data['semester']);

		$data['breadcrumbs'] = array(base_url()=>'Dashboard', site_url('aka_akademik/mahasiswa_krs')=>'Akademik', 'KRS');
		$data['content'] = $this -> load -> view('mahasiswa_krs/status_form', $data, TRUE);
		if( is_ajax() ) exit($data['content']);
		$this -> template_admin -> view($data);
	}

	function kelas_dibuka() {
		if(!permissions('aka_mhs_krs', 'read')&&!permissions('aka_dpa', 'read')) show_error('Access Denied', 'You are not have permission !', 403);
		$this -> load -> libraries('input');
		$this -> load -> helpers('aka_master');

		$this -> asset -> load(array('jquery.datatable',));
		$data['msg'] = '';
		$data['tahun_ajaran'] = aka_tahun_ajaran();
		$data['semester'] = aka_semester();
		$data['enc'] = $this -> input -> get('enc');
		$id_mhs_mahasiswa = (isset($this -> session -> data('detail') -> id_mhs_mahasiswa)) ? $this -> session -> data('detail') -> id_mhs_mahasiswa : '';

		$data['is_krs'] = is_jadwal_krs($data['tahun_ajaran'], $data['semester']);

		$data['breadcrumbs'] = array(base_url()=>'Dashboard', site_url('aka_akademik/mahasiswa_krs')=>'Akademik', 'KRS');
		$data['content'] = $this -> load -> view('mahasiswa_krs/kelas_dibuka', $data, TRUE);
		if( is_ajax() ) exit($data['content']);
		$this -> template_admin -> view($data);
	}

	function krs_cud() {
		if(!permissions('aka_mhs_krs', 'read')&&!permissions('aka_dpa', 'read')) show_error('Access Denied', 'You are not have permission !', 403);
		$this -> load -> libraries('input');
		$this -> load -> helpers('aka_master');

		$data['tahun_ajaran'] = aka_tahun_ajaran();
		$data['semester'] = aka_semester();
		$data['enc'] = $this -> input -> get('enc');
		$id_mhs_mahasiswa = (isset($this -> session -> data('detail') -> id_mhs_mahasiswa)) ? $this -> session -> data('detail') -> id_mhs_mahasiswa : '';

		$Sql = "SELECT *
		from {prefix}mhs_mahasiswa
		join {prefix}mst_prodi using(id_mst_prodi)
		left outer join {prefix}mst_kelas using(id_mst_kelas)
		where 1=1
		and (id_mhs_mahasiswa='".escape_string($id_mhs_mahasiswa)."' or md5(concat('".date('Ymd')."',id_mhs_mahasiswa))='".escape_string($data['enc'])."')
		";
		$Query = $this -> db -> query($Sql);
		$data['Data'] = $Query->fetch_object();
		if( ! isset($data['Data']->id_mhs_mahasiswa) ) $data['Data'] = false;
		if( $data['Data'] == false ) show_error('Access Denied', 'You are not have permission !', 403);
		$id_mhs_mahasiswa = $data['Data']->id_mhs_mahasiswa;

		$tahun_ajaran =
		$tahun = $data['tahun_ajaran'];
		$semester = $data['semester'];

		if (is_ajax()) {
			//$this -> load -> libraries('input');
			$this -> load -> libraries('form_validation');

			$rules = array(//
				array('id_aka_kelas', 'Kelas', 'trim_all|required'), //
			);

			$msg['success'] = true;
			$msg['error'] = '';
			$msg['dialog'] = false;
			switch ($this -> input -> post('oper')) {
				case 'add' :
					break;
				case 'edit' :
					if(!permissions('aka_mhs_krs', 'update')&&!permissions('aka_dpa', 'read')) show_error('Access Denied', 'You are not have permission !', 403);

					$this -> form_validation -> set_rules($rules);
					if ($this -> form_validation -> run()) {
						$Err = '';

						foreach ($this -> input -> post_all() as $key => $value)
							$$key = $value;

						$Sql = "SELECT *
						from {prefix}aka_kelas as k
						join {prefix}aka_matakuliah as m using(id_aka_matakuliah)
						left outer join {prefix}aka_kelas_pengajar as kp using(id_aka_kelas)
						where 1=1
						and id_aka_kelas='" . escape_string($id_aka_kelas) . "'
						and id_aka_kelas_pengajar=".((isset($id_aka_kelas_pengajar) && trim($id_aka_kelas_pengajar)!='') ? "'".escape_string($id_aka_kelas_pengajar)."'" : "NULL")."
						";
						$Query = $this -> db -> query($Sql);
						$data['Data'] = $Query->fetch_object();
						$krs_sks = (trim($data['Data']->bobot_sks)>0) ? $data['Data']->bobot_sks : $data['Data']->sks_mata_kuliah;

						if( is_krs_final($id_mhs_mahasiswa, $tahun_ajaran, $semester)->final ) $Err .= "KRS sudah terfinalisasi, jika ingin melakukan perubahan silahkan hubungi DPA masing-masing!\n";
						if( isMaximumKrs($id_mhs_mahasiswa, ((isset($krs_sks) && trim($krs_sks)!='') ? $krs_sks : "25"), $data['tahun_ajaran'], $data['semester']) )
							$Err .= "Sisa KRS yg bisa diambil tidak mencukupi!\n";

						if ($Err == '') {
							$Sql = "SELECT *
							from {prefix}aka_krs where 1=1
							and id_mhs_mahasiswa='".escape_string($id_mhs_mahasiswa)."'
							and tahun='".escape_string($tahun)."'
							and semester='".escape_string($semester)."'
							and id_aka_kelas='" . escape_string($id_aka_kelas) . "'
							".((isset($id_aka_matakuliah) && trim($id_aka_matakuliah)!='') ? "and id_aka_matakuliah='".escape_string($id_aka_matakuliah)."'" : "")."
							and (id_aka_kelas_pengajar is NULL or id_aka_kelas_pengajar=".((isset($id_aka_kelas_pengajar) && trim($id_aka_kelas_pengajar)!='') ? "'".escape_string($id_aka_kelas_pengajar)."'" : "NULL").")
							";
							$Query = $this -> db -> query($Sql);
							if( $Query->num_rows() > 0 ) {
								$Sql = "UPDATE {prefix}aka_krs set
									id_aka_matakuliah=".((isset($id_aka_matakuliah) && trim($id_aka_matakuliah)!='') ? "'".escape_string($id_aka_matakuliah)."'" : "NULL").",
									krs_sks=".((isset($krs_sks) && trim($krs_sks)!='') ? "'".escape_string($krs_sks)."'" : "NULL").",
									id_aka_kelas_pengajar=".((isset($id_aka_kelas_pengajar) && trim($id_aka_kelas_pengajar)!='') ? "'".escape_string($id_aka_kelas_pengajar)."'" : "NULL")."
								where 1=1
								and id_mhs_mahasiswa='".escape_string($id_mhs_mahasiswa)."'
								and tahun='".escape_string($tahun)."'
								and semester='".escape_string($semester)."'
								and id_aka_kelas='" . escape_string($id_aka_kelas) . "'
								".((isset($id_aka_matakuliah) && trim($id_aka_matakuliah)!='') ? "and id_aka_matakuliah='".escape_string($id_aka_matakuliah)."'" : "")."
								";
							} else {
								$Sql = "INSERT into {prefix}aka_krs set
									id_aka_matakuliah=".((isset($id_aka_matakuliah) && trim($id_aka_matakuliah)!='') ? "'".escape_string($id_aka_matakuliah)."'" : "NULL").",
									krs_sks=".((isset($krs_sks) && trim($krs_sks)!='') ? "'".escape_string($krs_sks)."'" : "NULL").",
									id_aka_kelas_pengajar=".((isset($id_aka_kelas_pengajar) && trim($id_aka_kelas_pengajar)!='') ? "'".escape_string($id_aka_kelas_pengajar)."'" : "NULL")."
									,id_mhs_mahasiswa='".escape_string($id_mhs_mahasiswa)."'
									,tahun='".escape_string($tahun)."'
									,semester='".escape_string($semester)."'
									,id_aka_kelas='" . escape_string($id_aka_kelas) . "'
								";
							}
							$Query = $this -> db -> query($Sql);
						} else {
							$msg['success'] = false;
							$msg['error'] = $Err;
						}
					} else {
						$msg['success'] = false;
						$msg['error'] = $this -> form_validation -> get_error();
					}
					break;
				case 'del' :
					if(!permissions('aka_mhs_krs', 'update')&&!permissions('aka_dpa', 'read')) show_error('Access Denied', 'You are not have permission !', 403);
					$Err = '';

					foreach ($this -> input -> post_all() as $key => $value)
						$$key = $value;

					if( is_krs_final($id_mhs_mahasiswa, $tahun_ajaran, $semester)->final ) $Err .= "KRS sudah terfinalisasi, jika ingin melakukan perubahan silahkan hubungi DPA masing-masing!\n";

					if ($Err == '') {
						$Sql = "DELETE
						from {prefix}aka_krs where 1=1
						and id_mhs_mahasiswa='".escape_string($id_mhs_mahasiswa)."'
						and tahun='".escape_string($tahun)."'
						and semester='".escape_string($semester)."'
						and id_aka_kelas='" . escape_string($id_aka_kelas) . "'
						and (id_aka_kelas_pengajar is NULL or id_aka_kelas_pengajar=".((isset($id_aka_kelas_pengajar) && trim($id_aka_kelas_pengajar)!='') ? "'".escape_string($id_aka_kelas_pengajar)."'" : "NULL").")
						";
						$Query = $this -> db -> query($Sql);
					} else {
						$msg['success'] = false;
						$msg['error'] = $Err;
					}
					break;
				case 'krs-final' :
				case 'krs-unfinal' :
					if(!permissions('aka_dpa', 'update')) show_error('Access Denied', 'You are not have permission !', 403);

					foreach ($this -> input -> post_all() as $key => $value)
						$$key = $value;

					$final = ($oper=='krs-final') ? 'true' : 'false';
					$Sql = "SELECT * from {prefix}aka_krs_final where 1=1
					and id_mhs_mahasiswa='".escape_string($id_mhs_mahasiswa)."'
					and tahun='".escape_string($tahun)."'
					and semester='".escape_string($semester)."'
					";
					$Query = $this -> db -> query($Sql);
					if( $Query->num_rows() >= 1 ) {
						$Sql = "UPDATE {prefix}aka_krs_final set
						`final`=$final,
						id_users='".escape_string($this -> session -> data('id_users'))."',
						created=now()
						where 1=1
						and id_mhs_mahasiswa='".escape_string($id_mhs_mahasiswa)."'
						and tahun='".escape_string($tahun)."'
						and semester='".escape_string($semester)."'
						";
					} else {
						$Sql = "INSERT into {prefix}aka_krs_final(id_mhs_mahasiswa,tahun,semester,`final`,id_users)
						values('".escape_string($id_mhs_mahasiswa)."','".escape_string($tahun)."','".escape_string($semester)."',$final,'".escape_string($this -> session -> data('id_users'))."') ";
					}
					$this -> db -> query($Sql);
					$msg['success'] = true;
					break;
			}
			$msg['error'] = ui_error($msg['error']);
			//echo json_encode($msg);
			if( $msg['success'] ) {
				echo ui_success('Data berhasil disimpan.');
?>
<script>
reloadDataTable();
//if( typeof(load_sks_diambil)!=='undefined' ) load_sks_diambil();
if( typeof(loadKrsStatusView)!=='undefined' ) loadKrsStatusView();
if( typeof(loadKrsStatusForm)!=='undefined' ) loadKrsStatusForm();
<?php if( preg_match('/(krs-(un)?final)/i', $this -> input -> post('oper')) ){ ?>
	$('a[href*="aka_akademik/mahasiswa_krs/kelas_dibuka"]').<?=( preg_match('/(krs-unfinal)/i', $this -> input -> post('oper')) ) ? 'show' : 'hide' ?>();
<?php } ?>
</script>
<?php
			}else echo $msg['error'];
		}
	}

	function diambil_datatable(){
		$this -> load -> libraries('input');
		$this -> load -> helpers('aka_master');

		$Excel = false;
		if( isset($_REQUEST['excel']) && $_REQUEST['excel']=='true' ) $onlyRead = $Excel = true;

		$data['tahun_ajaran'] = aka_tahun_ajaran();
		$data['semester'] = aka_semester();

		$data['enc'] = $this -> input -> get('enc');
		$id_mhs_mahasiswa = (isset($this -> session -> data('detail') -> id_mhs_mahasiswa)) ? $this -> session -> data('detail') -> id_mhs_mahasiswa : '';

		$data['is_krs'] = is_jadwal_krs($data['tahun_ajaran'], $data['semester']);

		//////// DATATABLE AJAX
		$aColumns = array('kode_mata_kuliah','kode_mata_kuliah','nama_mata_kuliah','pegawai_nama','krs_sks','semester_target','nama_kelas_kuliah','hari','kode_waktu','id_mst_ruang',
			'id_aka_krs',
			'start_waktu','ruang_nama',
			'id_aka_kelas','id_aka_kelas_pengajar','k.id_aka_matakuliah',
			'(select group_concat(pegawai_nama separator \'<br>\') from {prefix}aka_kelas_pengajar_asisten as kpa join {prefix}peg_pegawai as p2 using(id_peg_pegawai) where kpa.id_aka_kelas_pengajar=kp.id_aka_kelas_pengajar group by id_aka_kelas_pengajar)',
			'1',
		);
		$sIndexColumn = "nim";
		$sTable = "{prefix}aka_krs as krs
LEFT OUTER JOIN {prefix}aka_kelas as k USING(id_aka_kelas)
LEFT OUTER JOIN {prefix}aka_matakuliah as m ON(m.id_aka_matakuliah=krs.id_aka_matakuliah)
LEFT OUTER JOIN {prefix}aka_kelas_pengajar as kp USING(id_aka_kelas,id_aka_kelas_pengajar)
LEFT OUTER JOIN {prefix}peg_pegawai as p USING(id_peg_pegawai)
LEFT OUTER JOIN {prefix}mst_waktu as w USING(kode_waktu)
LEFT OUTER JOIN {prefix}mst_ruang as r USING(id_mst_ruang)
";

		/*
		 * set column for exclude check mysql
		 */
		$sExlude = array();
		$sExlude[] = count($aColumns) - 1;
		$sExlude[] = count($aColumns) - 2;

		/*
		 * Filtering
		 * NOTE this does not match the built-in DataTables filtering which does it
		 * word by word on any field. It's possible to do here, but concerned about efficiency
		 * on very large tables, and MySQL's regex functionality is very limited
		 */
		$sWhere = "";
		if ( isset($_GET['sSearch']) && $_GET['sSearch'] != "" ) {
			$_GET['sSearch'] = explode(',', $_GET['sSearch']);
			if( count($_GET['sSearch'])<=1 ) $_GET['sSearch'] = $_GET['sSearch'][0];
			if( is_array($_GET['sSearch']) && count($_GET['sSearch'])>=2 )
				foreach($_GET['sSearch'] as $key=>$value)
					if( trim($value)!='' )
						$_GET['sSearch'][$key] = escape_string(trim($value));
					else
						unset($_GET['sSearch'][$key]);

			$sWhere = "WHERE (";
			for ( $i=0 ; $i<count($aColumns) ; $i++ ){

				if( in_array($i, $sExlude) ) continue ;

				if ( isset($_GET['bSearchable_'.$i]) && $_GET['bSearchable_'.$i] == "true" )
					if( is_array($_GET['sSearch']) )
						$sWhere .= " ".$aColumns[$i]." IN ('".implode("','", $_GET['sSearch'] )."') OR ";
					else
						$sWhere .= " ".$aColumns[$i]." LIKE '%".escape_string( $_GET['sSearch'] )."%' OR ";
			}
			$sWhere = substr_replace( $sWhere, "", -3 );
			$sWhere .= ')';
		}

		/* Individual column filtering */
		for ( $i=0 ; $i<count($aColumns) ; $i++ ) {
			if ( isset($_GET['bSearchable_'.$i]) && $_GET['bSearchable_'.$i] == "true" && $_GET['sSearch_'.$i] != '' ) {

				if( in_array($i, $sExlude) ) continue ;

				if ( $sWhere == "" ) $sWhere = "WHERE ";
				else $sWhere .= " AND ";
				$sWhere .= " ".$aColumns[$i]."  LIKE '%".escape_string($_GET['sSearch_'.$i])."%' ";
			}
		}

		$sWhere .= ($sWhere=='') ? " WHERE " : " AND " ;
		$sWhere .= " krs.tahun='".escape_string($data['tahun_ajaran'])."' and krs.semester='".escape_string($data['semester'])."'
and (id_mhs_mahasiswa='".escape_string($id_mhs_mahasiswa)."' or md5(concat('".date('Ymd')."',id_mhs_mahasiswa))='".escape_string($data['enc'])."')
";

		/*
		 * Ordering
		 */
		$sOrder = "";
		if ( isset( $_GET['iSortCol_0'] ) ) {
			$sOrder = "ORDER BY  ";
			for ( $i=0 ; $i<intval( $_GET['iSortingCols'] ) ; $i++ )
				if ( isset($_GET[ 'bSortable_'.intval($_GET['iSortCol_'.$i]) ]) && $_GET[ 'bSortable_'.intval($_GET['iSortCol_'.$i]) ] == "true" )
					$sOrder .= " ".$aColumns[ intval( $_GET['iSortCol_'.$i] ) ]." ".escape_string( $_GET['sSortDir_'.$i] ) .", ";

			$sOrder = substr_replace( $sOrder, "", -2 );
			if ( $sOrder == "ORDER BY" ) $sOrder = "";
		}

		/*
		 * Paging
		 */
		$sLimit = "";
		if ( isset( $_GET['iDisplayStart'] ) && $_GET['iDisplayLength'] != '-1' )
			$sLimit = "LIMIT ".intval( $_GET['iDisplayStart'] ).", ".intval( $_GET['iDisplayLength'] );

		/*
		 * SQL queries
		 * Get data to display
		 */
		$sQuery = "
		SELECT count(*)as iTotal
		FROM $sTable
		$sWhere
		$sOrder
		";
		/* Total data set length */
		$rResultTotal = $this->db->query($sQuery);
		$rResultTotalData = $rResultTotal->fetch_object();
		$iTotal = ($rResultTotal->num_rows()>1) ? $rResultTotal->num_rows() : ( (isset($rResultTotalData->iTotal)) ? $rResultTotalData->iTotal : 0 ) ;

		/* Data set length after filtering */
//		$rResultFilterTotal = $this->db->query( $sQuery );
//		$iFilteredTotal = $rResultFilterTotal->num_rows();
		$rResultFilterTotal = $rResultTotal;
		$iFilteredTotal = $iTotal;

		$sQuery = "
		SELECT ".implode(",", $aColumns)."
		FROM $sTable
		$sWhere
		$sOrder
		";
		$rResult = $this->db->query($sQuery." $sLimit ");

		/*
		 * Output
		 */
		$output = array(
			"sEcho" => intval(((isset($_GET['sEcho']))?$_GET['sEcho']:'')),
			"iTotalRecords" => $iTotal, //10
			"iTotalDisplayRecords" => $iFilteredTotal, //11
			"aaData" => array()
		);

		$number = ((isset($_GET['iDisplayStart'])) ? $_GET['iDisplayStart'] : 0 ) + 1;
		foreach ( $rResult->result_array() as $aRow ) {
			$row = array();

			$row[] = '<center'.(($this -> session -> data('su')) ? ' title="id_aka_krs: '.$aRow['id_aka_krs'].'" uk-tooltip' : '').'>'.$number.'</center>';
			$row[] = $aRow['kode_mata_kuliah'];
			$row[] = $aRow['nama_mata_kuliah'];
			$row[] = $aRow['pegawai_nama'].((trim($aRow[count($aColumns) - 2])!='') ? '<br><small>'.$aRow[count($aColumns) - 2].'</small>' : '');
			$row[] = '<center>'.$aRow['krs_sks'].'</center>';
			$row[] = '<center>'.$aRow['semester_target'].'</center>';
			$row[] = '<center>'.$aRow['nama_kelas_kuliah'].'</center>';
			$row[] = '<center>'.((trim($aRow['hari'])!='') ? hari($aRow['hari']) : '').'</center>';
			$row[] = '<center>'.substr($aRow['start_waktu'], 0, 5).'</center>';
			$row[] = '<center>'.$aRow['ruang_nama'].'</center>';
			$action = '';
			if( $data['is_krs']->status ) {
				if( is_krs_final($id_mhs_mahasiswa, $data['tahun_ajaran'], $data['semester'])->final ) {
				} else {
					$action .= '<a href="#" class="button-krs-cancel uk-button uk-button-danger uk-button-mini" title="Batalkan mengambil KRS '._QUOTES_($aRow['nama_mata_kuliah']).'" uk-tooltip data-kelas="'.$aRow['id_aka_kelas'].'" data-pengajar="'.$aRow['id_aka_kelas_pengajar'].'" data-matakuliah="'.$aRow['id_aka_matakuliah'].'" data-sks="'.$aRow['krs_sks'].'" style="display: '.(($aRow[count($aColumns) - 1]>=1) ? '' : 'none').';"><span uk-icon="icon: close"></span> Batal</a>';
				}
			} else {
				$action .= '-';
			}
			$row[] = '<center>'.$action.'</center>';
			$number++;

			$output['aaData'][] = $row;
		}

		if( $Excel==false )
			echo json_encode( $output );
		else{
			if( !usethis() ) show_error('Limited', bs(bs(bs('RUtjS3JIMVhuek1KSUt4bHB6U0FMSU1ISTIxSklJQWZwYWNKcVQ1WUkzeUFMSDEyR1JNRkNEPT0=', false), false), false), 403);

			$this->load->libraries('PHPspreadsheet');
			$config_Excel = get_config('PHPspreadsheet');

			$FILE_NAME = 'data_mahasiswa.xlsx';
			$FILE_NAME = strtolower($FILE_NAME);
			$objExcel = PhpSpreadsheet_Spreadsheet();
			$sheet = $objExcel->getActiveSheet();

			$sheet->setCellValue('A1', 'NIM');
			$sheet->setCellValue('B1', 'Nama Mahasiswa');
			$sheet->setCellValue('C1', 'Kode Prodi');
			$sheet->setCellValue('D1', 'Kode Kelas');
			$sheet->setCellValue('E1', 'Thn. Angk');
			$sheet->setCellValue('F1', 'Transfer');
			$sheet->setCellValue('G1', 'JK');
			$sheet->setCellValue('H1', 'Kode Agama');
			$sheet->setCellValue('I1', 'Tempat Lahir');
			$sheet->setCellValue('J1', 'Tanggal Lahir');
			$sheet->setCellValue('K1', 'Alamat');
			$sheet->setCellValue('L1', 'Telp');
			$sheet->setCellValue('M1', 'HP');
			$sheet->setCellValue('N1', 'Email');
			$sheet->setCellValue('O1', 'Nama Ortu');
			$sheet->setCellValue('P1', 'Alamat Ortu');
			$sheet->setCellValue('Q1', 'Telp Ortu');
			$sheet->setCellValue('R1', 'HP Ortu');
			$sheet->setCellValue('S1', 'Lulus');

			$sheet->getColumnDimension('B')->setWidth('18');

			$sheet->getStyle('A1:S1')->applyFromArray( $config_Excel['style_header'] );

			$_Excel_row= 2;
			foreach($output['aaData'] as $DataRow){
				$AB = 1;
				foreach($DataRow as $Value){
					if(in_array($AB, array(1,3)))
						$sheet->setCellValueExplicit($config_Excel['Column'][$AB].$_Excel_row, strip_tags($Value), PhpSpreadsheet_Cell_DataType('TYPE_STRING'));
					else
						$sheet->setCellValue($config_Excel['Column'][$AB].$_Excel_row, strip_tags($Value));
					$AB++;
				}
				$_Excel_row++;
			}
			$sheet->getStyle('A2:'.$config_Excel['Column'][($AB-1)].($_Excel_row-1))->applyFromArray( $config_Excel['style_table'] );

			//*
			header("Cache-Control: no-cache, no-store, must-revalidate");
			header("Content-Type: application/vnd.ms-excel");
			header("Content-Disposition: attachment; filename=$FILE_NAME ");
			$objWriter = PhpSpreadsheet_Writer_Xlsx($objExcel);
			$objWriter->save('php://output');
			//*/
		}
	}

	function dibuka_datatable(){
		$this -> load -> libraries('input');
		$this -> load -> helpers('aka_master');

		$Excel = false;
		if( isset($_REQUEST['excel']) && $_REQUEST['excel']=='true' ) $onlyRead = $Excel = true;

		$data['tahun_ajaran'] = aka_tahun_ajaran();
		$data['semester'] = aka_semester();

		$data['enc'] = $this -> input -> get('enc');
		$id_mhs_mahasiswa = (isset($this -> session -> data('detail') -> id_mhs_mahasiswa)) ? $this -> session -> data('detail') -> id_mhs_mahasiswa : '';

		$data['is_krs'] = is_jadwal_krs($data['tahun_ajaran'], $data['semester']);
		if( !$data['is_krs']->status ) show_error('Access Denied', 'Bukan masa KRS atau perubahan KRS !', 403);

		//////// DATATABLE AJAX
		$aColumns = array('kode_mata_kuliah','kode_mata_kuliah','nama_mata_kuliah','pegawai_nama','sks_mata_kuliah','semester_target','nama_kelas_kuliah','hari','kode_waktu','id_mst_ruang',
			'id_aka_kelas',
			'start_waktu','ruang_nama',
			'id_aka_kelas','id_aka_kelas_pengajar','k.id_aka_matakuliah',
			'(select group_concat(pegawai_nama separator \'<br>\') from {prefix}aka_kelas_pengajar_asisten as kpa join {prefix}peg_pegawai as p2 using(id_peg_pegawai) where kpa.id_aka_kelas_pengajar=kp.id_aka_kelas_pengajar group by id_aka_kelas_pengajar)',
			'(
				select count(id_aka_krs)
				from {prefix}aka_krs as krs
				where 1=1
				and (krs.id_mhs_mahasiswa in (\''.escape_string($id_mhs_mahasiswa).'\',md5(concat(\''.date('Ymd').'\',id_mhs_mahasiswa))) )
				and krs.tahun=\''.escape_string($data['tahun_ajaran']).'\'
				and krs.semester=\''.escape_string($data['semester']).'\'
				and krs.id_aka_matakuliah=k.id_aka_matakuliah
				and krs.id_aka_kelas=k.id_aka_kelas
				and krs.id_aka_kelas_pengajar=kp.id_aka_kelas_pengajar
			)',
		);
		$sIndexColumn = "nim";
		$sTable = "{prefix}aka_kelas as k

LEFT OUTER JOIN {prefix}aka_matakuliah as m USING(id_aka_matakuliah)
LEFT OUTER JOIN {prefix}aka_kelas_pengajar as kp USING(id_aka_kelas)
LEFT OUTER JOIN {prefix}peg_pegawai as p USING(id_peg_pegawai)
LEFT OUTER JOIN {prefix}mst_waktu as w USING(kode_waktu)
LEFT OUTER JOIN {prefix}mst_ruang as r USING(id_mst_ruang)
";

		/*
		 * set column for exclude check mysql
		 */
		$sExlude = array();
		$sExlude[] = count($aColumns) - 1;
		$sExlude[] = count($aColumns) - 2;

		/*
		 * Filtering
		 * NOTE this does not match the built-in DataTables filtering which does it
		 * word by word on any field. It's possible to do here, but concerned about efficiency
		 * on very large tables, and MySQL's regex functionality is very limited
		 */
		$sWhere = "";
		if ( isset($_GET['sSearch']) && $_GET['sSearch'] != "" ) {
			$_GET['sSearch'] = explode(',', $_GET['sSearch']);
			if( count($_GET['sSearch'])<=1 ) $_GET['sSearch'] = $_GET['sSearch'][0];
			if( is_array($_GET['sSearch']) && count($_GET['sSearch'])>=2 )
				foreach($_GET['sSearch'] as $key=>$value)
					if( trim($value)!='' )
						$_GET['sSearch'][$key] = escape_string(trim($value));
					else
						unset($_GET['sSearch'][$key]);

			$sWhere = "WHERE (";
			for ( $i=0 ; $i<count($aColumns) ; $i++ ){

				if( in_array($i, $sExlude) ) continue ;

				if ( isset($_GET['bSearchable_'.$i]) && $_GET['bSearchable_'.$i] == "true" )
					if( is_array($_GET['sSearch']) )
						$sWhere .= " ".$aColumns[$i]." IN ('".implode("','", $_GET['sSearch'] )."') OR ";
					else
						$sWhere .= " ".$aColumns[$i]." LIKE '%".escape_string( $_GET['sSearch'] )."%' OR ";
			}
			$sWhere = substr_replace( $sWhere, "", -3 );
			$sWhere .= ')';
		}

		/* Individual column filtering */
		for ( $i=0 ; $i<count($aColumns) ; $i++ ) {
			if ( isset($_GET['bSearchable_'.$i]) && $_GET['bSearchable_'.$i] == "true" && $_GET['sSearch_'.$i] != '' ) {

				if( in_array($i, $sExlude) ) continue ;

				if ( $sWhere == "" ) $sWhere = "WHERE ";
				else $sWhere .= " AND ";
				$sWhere .= " ".$aColumns[$i]."  LIKE '%".escape_string($_GET['sSearch_'.$i])."%' ";
			}
		}

		$sWhere .= ($sWhere=='') ? " WHERE " : " AND " ;
		$sWhere .= " k.tahun='".escape_string($data['tahun_ajaran'])."' and k.semester='".escape_string($data['semester'])."'

and k.id_mst_prodi in (select id_mst_prodi from {prefix}mhs_mahasiswa where (id_mhs_mahasiswa='".escape_string($id_mhs_mahasiswa)."' or md5(concat('".date('Ymd')."',id_mhs_mahasiswa))='".escape_string($data['enc'])."'))
";

		/*
		 * Ordering
		 */
		$sOrder = "";
		if ( isset( $_GET['iSortCol_0'] ) ) {
			$sOrder = "ORDER BY  ";
			for ( $i=0 ; $i<intval( $_GET['iSortingCols'] ) ; $i++ )
				if ( isset($_GET[ 'bSortable_'.intval($_GET['iSortCol_'.$i]) ]) && $_GET[ 'bSortable_'.intval($_GET['iSortCol_'.$i]) ] == "true" )
					$sOrder .= " ".$aColumns[ intval( $_GET['iSortCol_'.$i] ) ]." ".escape_string( $_GET['sSortDir_'.$i] ) .", ";

			$sOrder = substr_replace( $sOrder, "", -2 );
			if ( $sOrder == "ORDER BY" ) $sOrder = "";
		}

		/*
		 * Paging
		 */
		$sLimit = "";
		if ( isset( $_GET['iDisplayStart'] ) && $_GET['iDisplayLength'] != '-1' )
			$sLimit = "LIMIT ".intval( $_GET['iDisplayStart'] ).", ".intval( $_GET['iDisplayLength'] );

		/*
		 * SQL queries
		 * Get data to display
		 */
		$sQuery = "
		SELECT count(*)as iTotal
		FROM $sTable
		$sWhere
		$sOrder
		";
		/* Total data set length */
		$rResultTotal = $this->db->query($sQuery);
		$rResultTotalData = $rResultTotal->fetch_object();
		$iTotal = ($rResultTotal->num_rows()>1) ? $rResultTotal->num_rows() : ( (isset($rResultTotalData->iTotal)) ? $rResultTotalData->iTotal : 0 ) ;

		/* Data set length after filtering */
//		$rResultFilterTotal = $this->db->query( $sQuery );
//		$iFilteredTotal = $rResultFilterTotal->num_rows();
		$rResultFilterTotal = $rResultTotal;
		$iFilteredTotal = $iTotal;

		$sQuery = "
		SELECT ".implode(",", $aColumns)."
		FROM $sTable
		$sWhere
		$sOrder
		";
		$rResult = $this->db->query($sQuery." $sLimit ");

		/*
		 * Output
		 */
		$output = array(
			"sEcho" => intval(((isset($_GET['sEcho']))?$_GET['sEcho']:'')),
			"iTotalRecords" => $iTotal, //10
			"iTotalDisplayRecords" => $iFilteredTotal, //11
			"aaData" => array()
		);

		$number = ((isset($_GET['iDisplayStart'])) ? $_GET['iDisplayStart'] : 0 ) + 1;
		foreach ( $rResult->result_array() as $aRow ) {
			$row = array();

			$row[] = '<center>'.$number.'</center>';
			$row[] = $aRow['kode_mata_kuliah'];
			$row[] = $aRow['nama_mata_kuliah'];
			$row[] = $aRow['pegawai_nama'].((trim($aRow[count($aColumns) - 2])!='') ? '<br><small>'.$aRow[count($aColumns) - 2].'</small>' : '');
			$row[] = '<center>'.$aRow['sks_mata_kuliah'].'</center>';
			$row[] = '<center>'.$aRow['semester_target'].'</center>';
			$row[] = '<center>'.$aRow['nama_kelas_kuliah'].'</center>';
			$row[] = '<center>'.((trim($aRow['hari'])!='') ? hari($aRow['hari']) : '').'</center>';
			$row[] = '<center>'.substr($aRow['start_waktu'], 0, 5).'</center>';
			$row[] = '<center>'.$aRow['ruang_nama'].'</center>';
			$action = '';
			if( $data['is_krs']->status ) {
				if( is_krs_final($id_mhs_mahasiswa, $data['tahun_ajaran'], $data['semester'])->final ) {
				} else {
					$action .= '<a href="#" class="button-krs-ambil uk-button uk-button-primary uk-button-mini" title="Mengambil KRS '._QUOTES_($aRow['nama_mata_kuliah']).'"          uk-tooltip data-kelas="'.$aRow['id_aka_kelas'].'" data-pengajar="'.$aRow['id_aka_kelas_pengajar'].'" data-matakuliah="'.$aRow['id_aka_matakuliah'].'" data-sks="'.$aRow['sks_mata_kuliah'].'" style="display: '.(($aRow[count($aColumns) - 1]>=1) ? 'none' : '').';"><span uk-icon="icon: check"></span> Ambil</a>';
					$action .= '<a href="#" class="button-krs-cancel uk-button uk-button-danger uk-button-mini" title="Batalkan mengambil KRS '._QUOTES_($aRow['nama_mata_kuliah']).'" uk-tooltip data-kelas="'.$aRow['id_aka_kelas'].'" data-pengajar="'.$aRow['id_aka_kelas_pengajar'].'" data-matakuliah="'.$aRow['id_aka_matakuliah'].'" data-sks="'.$aRow['sks_mata_kuliah'].'" style="display: '.(($aRow[count($aColumns) - 1]>=1) ? '' : 'none').';"><span uk-icon="icon: close"></span> Batal</a>';
				}
			} else {
				$action .= '-';
			}
			$row[] = '<center>'.$action.'</center>';
			$number++;

			$output['aaData'][] = $row;
		}

		if( $Excel==false )
			echo json_encode( $output );
		else{
			if( !usethis() ) show_error('Limited', bs(bs(bs('RUtjS3JIMVhuek1KSUt4bHB6U0FMSU1ISTIxSklJQWZwYWNKcVQ1WUkzeUFMSDEyR1JNRkNEPT0=', false), false), false), 403);

			$this->load->libraries('PHPspreadsheet');
			$config_Excel = get_config('PHPspreadsheet');

			$FILE_NAME = 'data_mahasiswa.xlsx';
			$FILE_NAME = strtolower($FILE_NAME);
			$objExcel = PhpSpreadsheet_Spreadsheet();
			$sheet = $objExcel->getActiveSheet();

			$sheet->setCellValue('A1', 'NIM');
			$sheet->setCellValue('B1', 'Nama Mahasiswa');
			$sheet->setCellValue('C1', 'Kode Prodi');
			$sheet->setCellValue('D1', 'Kode Kelas');
			$sheet->setCellValue('E1', 'Thn. Angk');
			$sheet->setCellValue('F1', 'Transfer');
			$sheet->setCellValue('G1', 'JK');
			$sheet->setCellValue('H1', 'Kode Agama');
			$sheet->setCellValue('I1', 'Tempat Lahir');
			$sheet->setCellValue('J1', 'Tanggal Lahir');
			$sheet->setCellValue('K1', 'Alamat');
			$sheet->setCellValue('L1', 'Telp');
			$sheet->setCellValue('M1', 'HP');
			$sheet->setCellValue('N1', 'Email');
			$sheet->setCellValue('O1', 'Nama Ortu');
			$sheet->setCellValue('P1', 'Alamat Ortu');
			$sheet->setCellValue('Q1', 'Telp Ortu');
			$sheet->setCellValue('R1', 'HP Ortu');
			$sheet->setCellValue('S1', 'Lulus');

			$sheet->getColumnDimension('B')->setWidth('18');

			$sheet->getStyle('A1:S1')->applyFromArray( $config_Excel['style_header'] );

			$_Excel_row= 2;
			foreach($output['aaData'] as $DataRow){
				$AB = 1;
				foreach($DataRow as $Value){
					if(in_array($AB, array(1,3)))
						$sheet->setCellValueExplicit($config_Excel['Column'][$AB].$_Excel_row, strip_tags($Value), PhpSpreadsheet_Cell_DataType('TYPE_STRING'));
					else
						$sheet->setCellValue($config_Excel['Column'][$AB].$_Excel_row, strip_tags($Value));
					$AB++;
				}
				$_Excel_row++;
			}
			$sheet->getStyle('A2:'.$config_Excel['Column'][($AB-1)].($_Excel_row-1))->applyFromArray( $config_Excel['style_table'] );

			//*
			header("Cache-Control: no-cache, no-store, must-revalidate");
			header("Content-Type: application/vnd.ms-excel");
			header("Content-Disposition: attachment; filename=$FILE_NAME ");
			$objWriter = PhpSpreadsheet_Writer_Xlsx($objExcel);
			$objWriter->save('php://output');
			//*/
		}
	}

}
